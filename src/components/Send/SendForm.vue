<template>
  <div id="scan-form">
    <div class="current-balance">
      <div class="left">
        <p>Current Balance</p>
      </div>
      <div class="right">
        <p>{{confirmedBalance}} <span class="bolder">PARK</span></p>
      </div>
    </div>

    <form @submit.prevent="confirmSend">
      <div class="field">
        <label class="label">Please enter the destination PARK Wallet Address</label>
        <div class="control">
          <input class="input"
            type="text"
            placeholder="Parking Wallet"
            v-model="sendData.address">
        </div>
      </div>

      <div class="field">
        <label class="label">Amount to send</label>
        <div class="control">
          <input class="input"
            type="number"
            step="0.000001"
            placeholder="Parking Wallet"
            v-model="sendData.amount">
        </div>
      </div>
      <button type="submit" class="button is-primary" :disabled="!isFormValid">Send</button>
    </form>
  </div>
</template>

<script>
import WAValidator from 'wallet-address-validator';

export default {
  props: ['address'],
  data() {
    return {
      sendData: {
        address: '',
        amount: null,
      },
    };
  },
  computed: {
    isFormValid() {
      let isValid = false;
      if (this.sendData.address &&
        this.sendData.amount &&
        WAValidator.validate(this.sendData.address, 'PARK') &&
        this.sendData.amount <= this.confirmedBalance &&
        this.sendData.amount > 0) {
        isValid = true;
      }
      return isValid;
    },
    confirmedBalance() {
      // return 0;
      return this.$store.state.Wallet.balance;
    },
  },
  methods: {
    updateBalance() {
      this.$store.dispatch('updateBalance');
    },
    confirmSend() {
      if (this.isFormValid) {
        this.$dialog.confirm({
          title: 'Confirm Transaction',
          message: `You are about to send <b>${this.sendData.amount}</b> to <b>${this.sendData.address}</b>. 0.00001 PARK will be added as tx fees \
           thats a total of <b>${Number(this.sendData.amount) + 0.00001} PARK</b>. Do you want to continue?`,
          confirmText: 'Continue',
          type: 'is-success',
          hasIcon: true,
          onConfirm: () => this.sendCoins(),
        });
      }
    },
    sendCoins() {
      if (this.confirmedBalance >= (Number(this.sendData.amount) + 0.00001)) {
        this.$store.dispatch('sendCoins', {
          sendData: this.sendData,
        });
      } else {
        this.$toast.open({
          message: 'You haven\'t enought balance',
          queue: false,
        });
      }
    },
  },
  mounted() {
    this.updateBalance();

    if (this.address) {
      this.sendData.address = this.address;
    }
  },
};
</script>

<style lang="scss" scoped>
#scan-form {
  background: rgba(255,255,255,0.70);
  box-shadow: 0 2px 8px 0 #5C5C5C;
  border-radius: 10px;
  color: #000;
  min-height: 50px;
  padding: 20px 30px;
  margin: 30px auto;
  width: 50%;

  @media screen and (max-width: $break-mobile) {
    width: 90%;
  }
}

.current-balance {
  clear: both;

  .left {
    float: left;
  }

  .right {
    float: right;

    .bolder {
      font-weight: bolder;
    }
  }
}

form {
  clear: both;
  margin-top: 50px;

  label.label {
    text-align: left;
    font-weight: lighter;
  }

  button {
    width: 50%;
    margin-top: 15px;
  }
}
</style>
